pandocfilters
=============

A python module for writing `pandoc <http://pandoc.org/>`_ filters

Pandoc Filters
--------------------------
Pandoc filters are pipes that read a JSON serialization of
the Pandoc AST from stdin, transform it in some way, and
write it to stdout. They can be used with pandoc (>= 1.12)
either using pipes ::

    pandoc -t json -s | ./caps.py | pandoc -f json

or using the ``--filter`` (or ``-F``) command-line option. ::

    pandoc --filter ./caps.py -s

For more on pandoc filters, see the pandoc documentation under ``--filter``
and `the tutorial on writing filters`__.

__ http://johnmacfarlane.net/pandoc/scripting.html

Installation
--------------------------
Run this inside the present directory::

    python setup.py install

Or install from PyPI::

    pip install pandocfilters

Functions
--------------------------
The ``pandocfilters`` module exports the following functions:

``walk(x, action, format, meta)``
  Walk a tree, applying an action to every object.
  Returns a modified tree.

``toJSONFilter(action)``
  Converts an action into a filter that reads a JSON-formatted
  pandoc document from stdin, transforms it by walking the tree
  with the action, and returns a new JSON-formatted pandoc document
  to stdout.  The argument is a function ``action(key, value, format, meta)``,
  where key is the type of the pandoc object (e.g. ``'Str'``, ``'Para'``),
  value is the contents of the object (e.g. a string for ``'Str'``,
  a list of inline elements for ``'Para'``), format is the target
  output format (which will be taken for the first command line
  argument if present), and meta is the document's metadata.
  If the function returns None, the object to which it applies
  will remain unchanged.  If it returns an object, the object will
  be replaced.  If it returns a list, the list will be spliced in to
  the list to which the target object belongs.  (So, returning an
  empty list deletes the object.)

``stringify(x)``
  Walks the tree ``x`` and returns concatenated string content,
  leaving out all formatting.

``attributes(attrs)``
  Returns an attribute list, constructed from the
  dictionary ``attrs``.

Usage
--------------------------
Most users will only need ``toJSONFilter``.  Here is a simple example
of its use::

    #!/usr/bin/env python

    """
    Pandoc filter to convert all regular text to uppercase.
    Code, link URLs, etc. are not affected.
    """

    from pandocfilters import toJSONFilter, Str

    def caps(key, value, format, meta):
      if key == 'Str':
        return Str(value.upper())

    if __name__ == "__main__":
      toJSONFilter(caps)

Examples
--------------------------
The examples subdirectory in the source repository demonstrates
various filters. These filters are a useful starting point for
developing new pandocfilters.

``abc.py``
    Pandoc filter to process code blocks with class ``abc`` containing ABC
    notation into images. Assumes that abcm2ps and ImageMagick's convert
    are in the path. Images are put in the abc-images directory.

``caps.py``
    Pandoc filter to convert all regular text to uppercase. Code, link
    URLs, etc. are not affected.

``comments.py``
    Pandoc filter that causes everything between
    ``<!-- BEGIN COMMENT -->`` and ``<!-- END COMMENT -->`` to be ignored.
    The comment lines must appear on lines by themselves, with blank
    lines surrounding

``deemph.py``
    Pandoc filter that causes emphasized text to be displayed in ALL
    CAPS.

``deflists.py``
    Pandoc filter to convert definition lists to bullet lists with the
    defined terms in strong emphasis (for compatibility with standard
    markdown).

``graphviz.py``
    Pandoc filter to process code blocks with class ``graphviz`` into
    graphviz-generated images.

``metavars.py``
    Pandoc filter to allow interpolation of metadata fields into a
    document. ``%{fields}`` will be replaced by the field's value, assuming
    it is of the type ``MetaInlines`` or ``MetaString``.

``myemph.py``
    Pandoc filter that causes emphasis to be rendered using the custom
    macro ``\myemph{...}`` rather than ``\emph{...}`` in latex. Other output
    formats are unaffected.

``theorem.py``
    Pandoc filter to convert divs with ``class="theorem"`` to LaTeX theorem
    environments in LaTeX output, and to numbered theorems in HTML
    output.

``tikz.py``
    Pandoc filter to process raw latex tikz environments into images.
    Assumes that pdflatex is in the path, and that the standalone
    package is available. Also assumes that ImageMagick's convert is in
    the path. Images are put in the ``tikz-images`` directory.

Keys
--------------------------
Most of the pandocfilter examples rely check the value of a key for
a specific key value. This section provides an overview of these keys.

Block Elements

``BlockQuote``
    A [block quote](https://daringfireball.net/projects/markdown/syntax#blockquote) (list of blocks).

``BulletList``
    A [bullet list](https://daringfireball.net/projects/markdown/syntax#list) (list of items, each a list of blocks).

``CodeBlock``
    A [code block](https://daringfireball.net/projects/markdown/syntax#precode) (literal) with attributes.

``DefinitionList``
    Definition list Each list item is a pair consisting of a term
    (a list of inlines) and one or more definitions (each a list of
    blocks).

``Div``
    Generic block container with attributes.
    
``Header``
    Header - level (integer) and text (inlines).

``HorizontalRule``
    A [horizontal rule](https://daringfireball.net/projects/markdown/syntax#hr)

``Null``
    Nothing.

``OrderedList``
    An ordered list (attributes and a list of items, each a list of blocks)

``Para``
    A [paragraph](https://daringfireball.net/projects/markdown/syntax#p)
    of text.

``Plain``
    Plain text, not a paragraph.

``RawBlock``
    A raw text block.

``Table``
    A table, with caption, column alignments (required), relative column
    widths (0 = default), column headers (each a list of blocks), and
    rows (each a list of lists of blocks)

Inline Elements

``Cite``
    Citation (list of inlines).

``Code``
    Inline code (literal).

``Emph``
    Emphasized text (list of inlines), typically italics.

``Image``
    Image: alt text (list of inlines), target.

``LineBreak``
    Hard line break.

``Link``
    Hyperlink: text (list of inlines), target.

``Math``
    TeX math (literal).

``Note``
    Footnote or endnote.

``Quoted``
    Quoted text (list of inlines).

``RawInline``
    Raw inline.

``SmallCaps``
    Small caps text (list of inlines).

``Space``
    Inter-word space.

``Span``
    Generic inline container with attributes.

``Str``
    Text (string)

``Strikeout``
    Strikeout text, also called strikethrough (list of inlines).

``Strong``
    Strongly emphasized text (list of inlines), typically bold.

``Subscript``
    Subscripted text (list of inlines).

``Superscript``
    Superscripted text (list of inlines).
